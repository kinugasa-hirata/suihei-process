<!-- Fixed views/summary.ejs -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Summary</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <style>
      .container {
        max-width: 1200px;
        margin-top: 0;
      }
      .summary-table {
        margin-top: 2rem;
      }
      .nav-links {
        margin-bottom: 2rem;
      }
      .no-data {
        padding: 2rem;
        text-align: center;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 2rem;
      }
      .highlight-cell {
        background-color: #fff3cd;
        font-weight: bold;
      }
      .table-responsive {
        overflow-x: auto;
      }
      .file-filter-form {
        background-color: #e9ecef;
        padding: 1rem;
        border-radius: 5px;
        margin-bottom: 1.5rem;
      }
      .form-range-group {
        display: flex;
        gap: 1rem;
        align-items: end;
      }
      .range-input {
        width: 120px;
      }

      .content-section {
        background-color: white;
        padding: 1rem;
        margin: 0;
      }

      .header-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        padding: 5px 0;
      }

      .company-info {
        font-weight: bold;
        font-size: 1.2em;
      }

      .editable {
        border-bottom: 1px solid #ccc;
        padding: 0 5px;
        min-width: 50px;
        display: inline-block;
      }

      .date-input {
        border: 1px solid #ccc;
        padding: 2px 5px;
        border-radius: 4px;
      }

      .note {
        margin: 15px 0;
        font-size: 0.9em;
        color: #666;
        padding-left: 5px;
      }

      .note::before {
        content: "※";
        margin-right: 5px;
      }

      .unit-note {
        text-align: right;
        font-weight: bold;
      }

      /* Table styles */
      .table {
        background-color: white;
      }

      .table td {
        text-align: center; /* Center align all table cells */
        vertical-align: middle;
      }

      .table thead td {
        background-color: white;
        font-weight: normal;
        text-align: center;
        vertical-align: middle;
        border: 1px solid #dee2e6;
      }

      .table tbody td {
        text-align: center; /* Ensure body cells are also centered */
      }

      /* Keep filename cell styles if needed */
      .filename-cell {
        text-align: center;
        font-weight: bold;
      }

      .table-bordered {
        border-color: #dee2e6;
      }

      .smaller-text {
        font-size: 0.9em;
      }

      /* Hide the indicator row but keep it functional */
      .table thead tr:last-child {
        position: absolute;
        visibility: hidden;
        pointer-events: none;
      }

      .button-container {
        margin: 20px 0;
        padding: 10px 0;
        border-top: 1px solid #eee;
      }

      .button-container button {
        margin-right: 10px;
      }

      .logs-container {
        margin-top: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .logs-header {
        padding: 10px;
        background-color: #f8f9fa;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logs-content {
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
      }

      .logs-content.hidden {
        display: none;
      }

      .toggle-icon {
        font-size: 12px;
      }

      @media print {
        /* Remove ALL headers and footers except page number */
        @page {
          size: A4 landscape;
          margin: 10mm;
          @bottom-right {
            content: counter(page);
          }
        }

        html,
        body {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          margin: 0;
          padding: 0;
        }

        /* Hide ALL browser elements except page number */
        head,
        title,
        meta {
          display: none !important;
        }

        /* Hide Data Summary and other unnecessary elements */
        h1,
        .nav-links,
        .file-filter-form,
        .button-container,
        .no-print,
        .page-header {
          display: none !important;
        }

        /* Remove URLs from printing */
        a,
        a[href]:after,
        a[href]:before {
          content: none !important;
          display: none !important;
        }

        /* A4 Landscape setup */
        body {
          width: 297mm; /* A4 width */
          height: 210mm; /* A4 height */
          margin: 0;
          padding: 0;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }

        /* Compact the layout */
        .container {
          width: 100%;
          max-width: none;
          margin: 0;
          padding: 5mm;
        }

        /* Adjust table for printing */
        .table {
          font-size: 9pt;
          margin: 0;
        }

        .table td,
        .table th {
          padding: 2px 4px;
        }

        /* Header adjustments */
        h2 {
          font-size: 14pt;
          margin: 0 0 5mm 0;
        }

        .header-info {
          margin: 2mm 0;
          font-size: 10pt;
        }

        /* Environment note and unit */
        .environment-note,
        .unit-note {
          font-size: 9pt;
          margin: 2mm 0;
        }

        /* Bottom note */
        .bottom-note {
          font-size: 9pt;
          margin-top: 3mm;
        }

        /* Hide all non-essential elements */
        .content-section {
          padding: 0;
          background-color: white;
          box-shadow: none;
        }
      }

      .invalid-value {
        color: #dc3545 !important; /* Red color */
        font-weight: bold;
      }

      /* Add styles for G-value indicators */
      .g-value-cell {
        position: relative;
      }

      .hidden-g-warning {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #dc3545;
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: help;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="content-section">
        <div class="container">
          <h2>水平ノズル全数検査成績書</h2>
          <div class="header-info">
            <div>
              <strong>品名:</strong> 水平ノズル
              <strong>仕様書番号:</strong> KDMP-0434
              <strong>担当者:</strong>
              <span class="editable" contenteditable="true" id="inspector"
                ><%= inspectorName %></span
              >
            </div>
          </div>
          <div class="header-info">
            <div style="white-space: nowrap">
              <strong>図番:</strong> P2MM302000 <strong>数量:</strong
              ><span id="fileCount"><%= files ? files.length : 0 %></span>個
              <strong>検査方法:</strong> 全数検査 <strong>検査日:</strong> <%=
              new Date().toLocaleDateString('ja-JP', { year: 'numeric', month:
              '2-digit', day: '2-digit' }).replace(/\//g, '/') %>
              <strong>納期:</strong>
              <input
                type="text"
                id="deliveryDatePicker"
                class="date-input flatpickr"
                placeholder="YYYY/MM/DD"
              />
            </div>
            <div class="company-info">㈱平田商店</div>
          </div>
          <div class="header-info">
            <div style="margin-left: auto">
              <button
                id="quickApproveButton"
                style="
                  width: 48px;
                  height: 48px;
                  border-radius: 50%;
                  background-color: white;
                  color: white;
                  border: none;
                  font-weight: bold;
                  cursor: pointer;
                  box-shadow: 0 2px 4px white;
                "
                title="一括承認"
              ></button>
            </div>
          </div>

          <div class="environment-note">
            <div>
              当社検査における環境は室温20℃±5℃、湿度40%±25%で管理された部屋で実施しております。
            </div>
          </div>

          <div class="unit-note">
            <div>単位（ｍｍ）</div>
          </div>
        </div>
      </div>

      <div class="container">
        <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-danger"><%= error %></div>
        <% } %> <% if (typeof files !== 'undefined' && files && files.length >
        0) { %>
        <!-- Summary table -->
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead>
              <!-- Specification rows -->
              <tr>
                <td>図面寸法</td>
                <td>8.2</td>
                <td>37.5</td>
                <td>15.9</td>
                <td>24.1</td>
                <td>Φ11.2</td>
                <td>Φ3.2全貫通</td>
                <td>Φ8.0</td>
                <td>深さ5.0</td>
                <td>P.C.D 30</td>
                <td>Φ155.4</td>
                <td>83.1</td>
                <td>Φ122.3</td>
                <td>嵌め合い</td>
                <td>目視点検</td>
                <td>（参考値）</td>
              </tr>
              <tr>
                <td>寸法公差</td>
                <td>±0.2</td>
                <td>±0.3</td>
                <td>±0.2</td>
                <td>±0.2</td>
                <td>＋0.2/0</td>
                <td>±0.1</td>
                <td>±0.2</td>
                <td>±0.1</td>
                <td>±0.2</td>
                <td>±0.5</td>
                <td>±0.3</td>
                <td>±0.5</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
              </tr>
              <tr>
                <td>上限値</td>
                <td>8.4</td>
                <td>37.8</td>
                <td>16.1</td>
                <td>24.3</td>
                <td>11.4</td>
                <td>3.3</td>
                <td>8.2</td>
                <td>5.1</td>
                <td>30.2</td>
                <td>155.9</td>
                <td>83.4</td>
                <td>122.8</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
              </tr>
              <tr>
                <td>下限値</td>
                <td>8.0</td>
                <td>37.2</td>
                <td>15.7</td>
                <td>23.9</td>
                <td>11.2</td>
                <td>3.1</td>
                <td>7.8</td>
                <td>4.9</td>
                <td>29.8</td>
                <td>154.9</td>
                <td>82.8</td>
                <td>121.8</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
              </tr>
              <tr>
                <td>測定器具</td>
                <td>三次元測定器</td>
                <td>三次元測定器</td>
                <td>三次元測定器</td>
                <td>三次元測定器</td>
                <td>ピンゲージ</td>
                <td>ピンゲージ</td>
                <td>三次元測定器</td>
                <td>三次元測定器</td>
                <td>三次元測定器</td>
                <td>三次元測定器</td>
                <td>三次元測定器</td>
                <td>三次元測定器</td>
                <td>治具</td>
                <td>目視</td>
                <td>秤</td>
              </tr>
              <tr>
                <td>記載事項</td>
                <td>測定値</td>
                <td>測定値</td>
                <td>測定値</td>
                <td>合否</td>
                <td>合否</td>
                <td>合否</td>
                <td>測定値</td>
                <td>測定値</td>
                <td>測定値</td>
                <td>測定値</td>
                <td>測定値</td>
                <td>測定値</td>
                <td>合否</td>
                <td>合否</td>
                <td>測定値</td>
              </tr>
              <!-- Original header row -->
              <tr>
                <th>Filename</th>
                <% var displayHeaders = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H',
                'I', 'J', 'K', 'L', 'M', 'N']; %> <% var internalHeaders = ['A',
                'B', 'C', 'D', 'E', 'F', 'G1', 'G2', 'G3', 'G4', 'H', 'I', 'J',
                'K', 'L', 'M', 'N']; %> <%
                displayHeaders.forEach(function(header) { %>
                <th><%= header %></th>
                <% }); %>
                <th>質量 (g)</th>
              </tr>
            </thead>
            <tbody>
              <% files.forEach(function(file) { %>
              <tr>
                <td class="filename-cell" data-file-id="<%= file.id %>">
                  <strong><%= file.filename %></strong>
                </td>
                <% displayHeaders.forEach(function(header) { %> <% if (header
                === 'G') { %>
                <td
                  class="<%= fileData[file.id]['G1'].value !== '-' && (!fileData[file.id]['G1'].isValid || !fileData[file.id]['G2'].isValid || !fileData[file.id]['G3'].isValid || !fileData[file.id]['G4'].isValid) ? 'invalid-value' : '' %> highlight-cell data-cell g-value-cell"
                  title="G1: <%= fileData[file.id]['G1'].value %>&#13;
                         G2: <%= fileData[file.id]['G2'].value %>&#13;
                         G3: <%= fileData[file.id]['G3'].value %>&#13;
                         G4: <%= fileData[file.id]['G4'].value %>"
                >
                  <%= fileData[file.id]['G1'].value %> <% const invalidCount =
                  ['G2', 'G3', 'G4'].filter(g => fileData[file.id][g].value !==
                  '-' && !fileData[file.id][g].isValid ).length; if
                  (invalidCount > 0) { %>
                  <span
                    class="hidden-g-warning"
                    title="他の <%= invalidCount %> 箇所の G 値が範囲外です"
                  >
                    <%= invalidCount %>
                  </span>
                  <% } %>
                </td>
                <% } else { %>
                <td
                  class="<%= fileData[file.id][header].value !== '-' && !fileData[file.id][header].isValid ? 'invalid-value' : '' %> highlight-cell data-cell"
                >
                  <%= fileData[file.id][header].value %>
                </td>
                <% } %> <% }); %>
                <td>
                  <% if (file.weight) { %> <%=
                  (parseFloat(file.weight)).toFixed(1) %> <% } else { %> <% if
                  (username !== 'hinkan') { %>
                  <span
                    class="text-muted weight-editable"
                    data-file-id="<%= file.id %>"
                    >Not set</span
                  >
                  <% } else { %>
                  <span class="text-muted">Not set</span>
                  <% } %> <% } %>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
          <div class="bottom-note" style="margin-top: 10px; text-align: left">
            ＊着脱容易なシールに識別番号を記載し製品裏の底面に貼り付ける。
          </div>
        </div>

        <!-- Buttons and Logs Container -->
        <div class="button-container" style="margin-top: 20px">
          <a
            href="/"
            class="button"
            style="
              display: inline-block;
              text-decoration: none;
              background-color: #007bff;
              color: white;
              padding: 8px 12px;
              border-radius: 4px;
              margin-right: 5px;
            "
            >アップロードに戻る</a
          >
          <button onclick="window.print()" class="btn btn-secondary">
            印刷
          </button>
        </div>

        <% } else { %>
        <div class="no-data">
          <h3>No Data Available</h3>
          <p class="text-muted">No files match your current filter criteria.</p>
          <a href="/" class="btn btn-primary">Go to Upload Page</a>
        </div>
        <% } %>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
    <script>
      // Initialize Flatpickr
      flatpickr("#deliveryDatePicker", {
        dateFormat: "Y/m/d",
        locale: "ja",
        allowInput: true,
      });

      // Quick approve button logic
      document
        .getElementById("quickApproveButton")
        .addEventListener("click", function () {
          const rows = document.querySelectorAll("tbody tr");
          rows.forEach((row) => {
            // Specifically target only the E, F, M, N columns (columns 5, 6, 14, 15)
            const cells = row.querySelectorAll(
              "td:nth-child(6), td:nth-child(7), td:nth-child(14), td:nth-child(15)"
            );
            cells.forEach((cell) => {
              if (
                cell.textContent.trim() === "-" ||
                cell.textContent.trim() === ""
              ) {
                cell.textContent = "合";
              }
            });
          });
        });
    </script>
  </body>
</html>
