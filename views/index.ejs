<!-- views/index.ejs -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Vercel Analytics script -->
    <script defer src="/_vercel/insights/script.js"></script>
    <title>TXT to JSON Processor</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <style>
      .container {
        max-width: 1200px;
        margin-top: 2rem;
      }
      .file-card {
        margin-bottom: 1.5rem;
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 1rem;
      }
      .file-content {
        display: flex;
        flex-direction: column;
      }
      .file-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
      }
      .weight-form {
        margin-top: 0.5rem;
      }
      .weight-input {
        max-width: 120px;
      }
      .weight-display {
        font-weight: bold;
        color: #0d6efd;
      }
      .logout-link {
        margin-left: 1rem;
      }
      .selected-files {
        background-color: #e7f5ff;
      }
      .select-checkbox {
        margin-right: 0.5rem;
      }
      .file-selection-tools {
        margin-bottom: 1rem;
        padding: 0.5rem;
        background-color: #f0f0f0;
        border-radius: 5px;
      }
      .select-all-label {
        margin-left: 0.5rem;
        margin-bottom: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>TXT to JSON Processor</h1>
        <div>
          <a href="/summary" class="btn btn-success">View Summary</a>
          <a href="/logout" class="btn btn-outline-danger logout-link"
            >Logout</a
          >
        </div>
      </div>

      <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger"><%= error %></div>
      <% } %>

      <div class="card mb-4">
        <div class="card-header">
          <h2 class="h5 mb-0">Upload TXT Files</h2>
        </div>
        <div class="card-body">
          <form action="/upload" method="post" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="files" class="form-label">Select TXT files:</label>
              <input
                type="file"
                class="form-control"
                id="files"
                name="files"
                multiple
                accept=".txt"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">If file already exists:</label>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="overwriteAction"
                  id="skipAction"
                  value="skip"
                  checked
                />
                <label class="form-check-label" for="skipAction">
                  Skip (don't re-upload)
                </label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="overwriteAction"
                  id="overwriteAction"
                  value="overwrite"
                />
                <label class="form-check-label" for="overwriteAction">
                  Overwrite existing data
                </label>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Upload</button>
          </form>
        </div>
      </div>

      <% if (typeof files !== 'undefined' && files && files.length > 0) { %>
      <!-- File selection tools -->
      <div class="file-selection-tools">
        <div class="d-flex align-items-center mb-2">
          <input type="checkbox" id="select-all" class="form-check-input" />
          <label for="select-all" class="select-all-label">Select All</label>
          <div class="ms-auto">
            <button id="view-selected" class="btn btn-sm btn-primary me-2">
              View Selected
            </button>
            <button id="export-weights" class="btn btn-sm btn-secondary me-2">
              Export Weights
            </button>
            <button id="import-weights" class="btn btn-sm btn-secondary">
              Import Weights
            </button>
          </div>
        </div>
        <div id="import-form" style="display: none" class="mt-2">
          <div class="input-group">
            <textarea
              id="import-data"
              class="form-control"
              placeholder='Paste JSON data like [{"fileName":"1234","weight":"100.0"},{"fileName":"1235","weight":"99.5"}]'
            ></textarea>
            <button id="process-import" class="btn btn-primary">Process</button>
          </div>
        </div>
      </div>

      <h2 class="mb-3">Uploaded Files</h2>
      <div class="row" id="file-list">
        <% files.forEach(function(file) { %>
        <div class="col-md-6">
          <div class="file-card" data-file-id="<%= file.id %>">
            <div class="d-flex align-items-start">
              <input
                type="checkbox"
                class="file-select form-check-input select-checkbox"
                data-file-id="<%= file.id %>"
              />
              <div class="file-content flex-grow-1">
                <h3 class="h5"><%= file.filename %></h3>
                <p class="text-muted mb-1">
                  Uploaded: <%= new Date(file.uploaded_at).toLocaleString() %>
                </p>

                <% if (file.weight !== null) { %>
                <div class="weight-display mb-2">
                  Weight: <%= file.weight %> g
                </div>
                <% } %>

                <div class="weight-form">
                  <div class="input-group mb-3">
                    <input
                      type="text"
                      class="form-control weight-input text-end"
                      data-file-id="<%= file.id %>"
                      placeholder="Weight in grams"
                      value="<%= file.weight !== null ? file.weight : '' %>"
                      inputmode="decimal"
                    />
                    <span class="input-group-text">g</span>
                  </div>
                </div>

                <div class="file-actions">
                  <a href="/files/<%= file.id %>" class="btn btn-primary btn-sm"
                    >View Data</a
                  >
                  <button
                    class="btn btn-danger btn-sm delete-file"
                    data-file-id="<%= file.id %>"
                  >
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <% }); %>
      </div>
      <% } else { %>
      <div class="alert alert-info">
        No files uploaded yet. Use the form above to upload TXT files.
      </div>
      <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Save weight for a file
      async function saveWeight(fileId, weight) {
        try {
          const response = await fetch("/update-weight", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ fileId, weight }),
          });
          const result = await response.json();
          return result.success;
        } catch (error) {
          console.error("Error saving weight:", error);
          return false;
        }
      }

      // Delete a file
      async function deleteFile(fileId) {
        if (
          !confirm(
            "Are you sure you want to delete this file? This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          const response = await fetch("/delete-file", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ fileId }),
          });

          const result = await response.json();

          if (result.success) {
            const fileCard = document.querySelector(
              `.file-card[data-file-id="${fileId}"]`
            );
            if (fileCard) {
              fileCard.closest(".col-md-6").remove();
            }
          } else {
            alert(
              "Failed to delete file: " + (result.error || "Unknown error")
            );
          }
        } catch (error) {
          console.error("Error deleting file:", error);
          alert("Error deleting file: " + error.message);
        }
      }

      // Update selected files count
      function updateSelectedCount() {
        const count = document.querySelectorAll(".file-select:checked").length;
        const total = document.querySelectorAll(".file-select").length;
        document.getElementById("select-all").checked =
          count === total && total > 0;
      }

      // When the DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Set up delete buttons
        document.querySelectorAll(".delete-file").forEach((button) => {
          button.addEventListener("click", function () {
            const fileId = this.getAttribute("data-file-id");
            deleteFile(fileId);
          });
        });

        // Handle select all checkbox
        const selectAllCheckbox = document.getElementById("select-all");
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener("change", function () {
            const isChecked = this.checked;
            document.querySelectorAll(".file-select").forEach((checkbox) => {
              checkbox.checked = isChecked;
              const card = checkbox.closest(".file-card");
              if (card) {
                card.classList.toggle("selected-files", isChecked);
              }
            });
          });
        }

        // Handle individual file selection
        document.querySelectorAll(".file-select").forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            const card = this.closest(".file-card");
            if (card) {
              card.classList.toggle("selected-files", this.checked);
            }
            updateSelectedCount();
          });
        });

        // View selected files
        const viewSelectedBtn = document.getElementById("view-selected");
        if (viewSelectedBtn) {
          viewSelectedBtn.addEventListener("click", function () {
            const selectedFiles = [];
            document
              .querySelectorAll(".file-select:checked")
              .forEach((checkbox) => {
                selectedFiles.push(checkbox.getAttribute("data-file-id"));
              });

            if (selectedFiles.length === 0) {
              alert("Please select at least one file to view.");
              return;
            }

            window.location.href = `/summary?selectedFiles=${selectedFiles.join(
              ","
            )}`;
          });
        }

        // Export weights
        const exportWeightsBtn = document.getElementById("export-weights");
        if (exportWeightsBtn) {
          exportWeightsBtn.addEventListener("click", async function () {
            try {
              const response = await fetch("/export-weights");
              const data = await response.json();

              if (data.length === 0) {
                alert("No weight data available to export.");
                return;
              }

              const jsonStr = JSON.stringify(data, null, 2);
              const blob = new Blob([jsonStr], { type: "application/json" });
              const url = URL.createObjectURL(blob);

              const a = document.createElement("a");
              a.href = url;
              a.download = `weights_export_${new Date()
                .toISOString()
                .slice(0, 10)}.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            } catch (error) {
              console.error("Error exporting weights:", error);
              alert("Error exporting weights: " + error.message);
            }
          });
        }

        // Import weights - show form
        const importWeightsBtn = document.getElementById("import-weights");
        if (importWeightsBtn) {
          importWeightsBtn.addEventListener("click", function () {
            const importForm = document.getElementById("import-form");
            importForm.style.display =
              importForm.style.display === "none" ? "block" : "none";
          });
        }

        // Process import
        const processImportBtn = document.getElementById("process-import");
        if (processImportBtn) {
          processImportBtn.addEventListener("click", async function () {
            const jsonData = document
              .getElementById("import-data")
              .value.trim();

            if (!jsonData) {
              alert("Please paste JSON data to import.");
              return;
            }

            try {
              // Validate JSON
              const weightData = JSON.parse(jsonData);

              if (!Array.isArray(weightData)) {
                alert("Invalid format. Data must be an array of objects.");
                return;
              }

              // Send to server
              const response = await fetch("/import-weights", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ weightData }),
              });

              const result = await response.json();

              if (result.success) {
                alert(result.message || "Weights imported successfully.");
                location.reload(); // Refresh the page to show updated weights
              } else {
                alert("Import failed: " + (result.error || "Unknown error"));
              }
            } catch (error) {
              console.error("Error importing weights:", error);
              alert("Error parsing JSON: " + error.message);
            }
          });
        }
      });

      // Update weight input event listeners
      document
        .querySelectorAll(".weight-input")
        .forEach((input, index, inputs) => {
          input.addEventListener("change", async function (e) {
            let weight = this.value;
            const fileId = this.dataset.fileId;

            // Ensure weight is formatted to one decimal place
            if (weight && !isNaN(weight)) {
              if (!weight.includes(".")) {
                weight += ".0"; // Append .0 if no decimal is present
              }
              const success = await saveWeight(fileId, weight);
              if (success) {
                // Update the display immediately
                let weightDisplay =
                  this.closest(".file-card").querySelector(".weight-display");
                if (!weightDisplay) {
                  weightDisplay = document.createElement("div");
                  weightDisplay.className = "weight-display mb-2";
                  this.closest(".file-content").insertBefore(
                    weightDisplay,
                    this.closest(".weight-form")
                  );
                }
                weightDisplay.textContent = `Weight: ${weight} g`;
              } else {
                alert("重量の保存に失敗しました。もう一度お試しください。");
              }
            }
          });

          // Handle focus event to set cursor at the end
          input.addEventListener("focus", function () {
            this.setSelectionRange(this.value.length, this.value.length);
          });

          // Handle Enter key separately
          input.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              const nextInput = inputs[index + 1];
              if (nextInput) {
                nextInput.focus();
              } else {
                this.blur();
              }
            }
          });
        });
    </script>
  </body>
</html>
