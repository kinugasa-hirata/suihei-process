<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script defer src="/_vercel/insights/script.js"></script>
    <title>æ¸¬å®šãƒ‡ãƒ¼ã‚¿è©³ç´°</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <style>
      .container { max-width: 1400px; margin-top: 2rem; }
      .file-info { background-color: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem; }
      .nav-links { margin-bottom: 2rem; }
      .table-responsive { overflow-x: auto; }
      .highlight {
        background-color: #fff3cd !important; border: 2px solid #ff6b35 !important;
        font-weight: 700; position: relative;
      }
      .highlight::after {
        content: attr(data-key); position: absolute; top: 2px; right: 2px;
        background: #ff6b35; color: white; padding: 2px 6px; border-radius: 3px;
        font-size: 10px; font-weight: 700;
      }
      .highlight-average { background-color: #d4edda !important; border: 2px solid #28a745 !important; font-weight: 700; }
      .highlight-average::after { background: #28a745; }
      .data-type-CIRCLE { color: #198754; font-weight: bold; }
      .data-type-PLANE { color: #0d6efd; font-weight: bold; }
      .data-type-DISTANCE { color: #ffc107; font-weight: bold; }
      .data-type-PT-COMP { color: #dc3545; font-weight: bold; }
      .invalid-value { color: #dc3545; font-weight: bold; }
      .legend {
        margin-top: 20px; padding: 15px; background: #f8f9fa;
        border-radius: 4px; font-size: 13px;
      }
      .legend h3 { margin-top: 0; margin-bottom: 10px; font-size: 14px; }
      .legend-item { display: inline-block; margin-right: 20px; margin-bottom: 5px; }
      .legend-box {
        display: inline-block; width: 20px; height: 20px; border: 2px solid #000;
        margin-right: 5px; vertical-align: middle;
      }
      .legend-highlight { background: #fff3cd; border-color: #ff6b35; }
      .legend-average { background: #d4edda; border-color: #28a745; }
      .user-info-banner {
        background: #e3f2fd; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px;
        display: flex; justify-content: space-between; align-items: center; border: 1px solid #90caf9;
      }
      .user-info-left { display: flex; align-items: center; gap: 15px; }
      .auth-badge { padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 500; }
      .badge-edit { background: #d4edda; color: #155724; }
      .badge-readonly { background: #e2e3e5; color: #383d41; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4">ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿è©³ç´°</h1>

      <div class="user-info-banner">
        <div class="user-info-left">
          <div>
            <span style="font-size: 16px;">ğŸ‘¤</span>
            <strong><%= displayName %></strong>
          </div>
          
          <% if (canEditWeights) { %>
            <span class="auth-badge badge-edit">âœ“ é‡é‡ç·¨é›†å¯</span>
          <% } else { %>
            <span class="auth-badge badge-readonly">ğŸ“– é–²è¦§ã®ã¿</span>
          <% } %>
        </div>
        
        <a href="/logout" class="btn btn-sm btn-outline-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
      </div>

      <div class="nav-links">
        <a href="/" class="btn btn-primary">Home</a>
      </div>

      <% if (typeof file !== 'undefined' && file) { %>
      <div class="file-info">
        <h2><%= file.filename %></h2>
        <div class="row">
          <div class="col-md-6">
            <p><strong>Uploaded:</strong> <%= new Date(file.uploaded_at).toLocaleString() %></p>
          </div>
          <div class="col-md-6">
            <p>
              <% if (typeof file.weight !== 'undefined' && file.weight !== null) { %>
                <strong>Weight:</strong> <%= Number(file.weight).toFixed(1) %> g
              <% } else { %>
                <strong>Weight:</strong> <span class="text-muted">Not set</span>
              <% } %>
            </p>

            <% if (canEditWeights) { %>
              <form action="/files/<%= file.$id %>/update-weight" method="post" id="weightForm">
                <div class="input-group" style="max-width: 300px">
                  <input type="hidden" name="fileId" value="<%= file.$id %>" />
                  <input type="text" class="form-control text-end" name="weight"
                    value="<%= file.weight !== null ? Number(file.weight).toFixed(1) : '' %>"
                    placeholder="Enter weight (g)" inputmode="decimal" />
                  <button type="submit" class="btn btn-primary">Update Weight</button>
                </div>
              </form>
            <% } else { %>
              <p class="text-muted" style="font-size: 14px; margin-top: 10px;">
                <em>ğŸ’¡ é‡é‡ã®ç·¨é›†ã¯ <strong>naemura</strong> ã¨ <strong>iwatsuki</strong> ã®ã¿å¯èƒ½ã§ã™</em>
              </p>
            <% } %>
          </div>
        </div>
      </div>
      <% } %> 
      
      <% if (typeof message !== 'undefined' && message) { %>
      <div class="alert alert-info"><%= message %></div>
      <% } %> 
      
      <% if (typeof data !== 'undefined' && data && data.length > 0) { %>
      <h3>æ¸¬å®šçµæœ</h3>
      <div class="table-responsive">
        <table class="table table-striped table-bordered" id="dataTable">
          <thead class="table-dark">
            <tr>
              <th>ID</th><th>Index</th><th>Type</th><th>X</th><th>Y</th><th>Z</th>
              <th>Rot X</th><th>Rot Y</th><th>Rot Z</th><th>Note</th><th>Diameter</th><th>Tolerance</th>
            </tr>
          </thead>
          <tbody>
            <% 
            var fieldMap = {
              'X': 'x', 'Y': 'y', 'Z': 'z', 'Rot X': 'rot_x', 'Rot Y': 'rot_y', 'Rot Z': 'rot_z',
              'Note': 'note', 'Diameter': 'diameter', 'Tolerance': 'tolerance'
            };
            
            function getCellHighlight(point, fieldName) {
              if (!highlights) return null;
              for (var i = 0; i < highlights.length; i++) {
                var h = highlights[i];
                if (h.index === point.index && h.type === point.data_type && h.field === fieldName) {
                  return h;
                }
              }
              return null;
            }
            %>
            
            <% data.forEach(function(point, rowIndex) { %>
            <tr data-index="<%= rowIndex %>">
              <td><%= point.$id || point.id %></td>
              <td><%= point.index %></td>
              <td class="data-type-<%= point.data_type %>"><%= point.data_type %></td>
              
              <% 
              var fields = ['X', 'Y', 'Z', 'Rot X', 'Rot Y', 'Rot Z', 'Note', 'Diameter', 'Tolerance'];
              fields.forEach(function(field) {
                var fieldKey = fieldMap[field];
                var value = point[fieldKey];
                var highlight = getCellHighlight(point, field);
                var classes = '';
                var dataKey = '';
                if (highlight) {
                  classes = highlight.isAverage ? 'highlight-average' : 'highlight';
                  dataKey = highlight.key;
                }
              %>
              
              <td class="<%= classes %>" <%= dataKey ? 'data-key="' + dataKey + '"' : '' %>>
                <% if(value !== null && value !== undefined && value !== '' && value !== '-') { %>
                  <%= typeof value === 'number' ? value.toFixed(3) : 
                      ((value === 'NaN' || value === 'NAN') ? 'NaN' : 
                      (parseFloat(value) ? parseFloat(value).toFixed(3) : value)) %>
                <% } else { %>
                  -
                <% } %>
              </td>
              
              <% }); %>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
      
      <div class="legend">
        <h3>å‡¡ä¾‹ (Legend)</h3>
        <div class="legend-item">
          <span class="legend-box legend-highlight"></span>
          <span>Export to Inspection Sheet (æ¤œæŸ»è¡¨ã«å‡ºåŠ›ã•ã‚Œã‚‹å€¤)</span>
        </div>
        <div class="legend-item">
          <span class="legend-box legend-average"></span>
          <span>Used for Average Calculation F (Få¹³å‡è¨ˆç®—ã«ä½¿ç”¨)</span>
        </div>
        <div class="legend-item"><span class="data-type-CIRCLE">â— CIRCLE</span></div>
        <div class="legend-item"><span class="data-type-PT-COMP">â— PT-COMP</span></div>
        <div class="legend-item"><span class="data-type-DISTANCE">â— DISTANCE</span></div>
      </div>
      <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var weightInput = document.querySelector('input[name="weight"]');
        var weightForm = document.getElementById("weightForm");
        if (weightInput && weightForm) {
          weightInput.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
              event.preventDefault();
              if (this.value) { weightForm.submit(); }
            }
          });
        }
      });
    </script>
  </body>
</html>